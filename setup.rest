
POST {{searchUrl}}/datasources?api-version={{apiVersion}}
Content-Type: application/json
api-key: {{apiKey}}

{
  "name": "sharepoint-datasource",
  "type": "sharepoint",
  "indexerPermissionOptions": ["userIds", "groupIds"],
  "credentials": {
    "connectionString": "SharePointOnlineEndpoint={{spoEndpoint}};ApplicationId={{spoAppId}};ApplicationSecret={{spoAppSecret}};TenantId={{spoTenantId}}"
  },
  "container": {
    "name": "defaultSiteLibrary",
    "query": null
  }
}

### Step 2: Create the search index (must run BEFORE skillset)

POST {{searchUrl}}/indexes?api-version={{apiVersion}}
Content-Type: application/json
api-key: {{apiKey}}

{
  "name": "sharepoint-docs-index",
  "fields": [
    { "name": "id",             "type": "Edm.String",  "key": true, "filterable": true, "analyzer": "keyword" },
    { "name": "parent_id",      "type": "Edm.String",  "filterable": true },
    { "name": "metadata_spo_item_path", "type": "Edm.String", "filterable": false, "retrievable": true },
    { "name": "title",          "type": "Edm.String",  "searchable": true, "filterable": true, "retrievable": true },
    { "name": "content",        "type": "Edm.String",  "searchable": true, "retrievable": true },
    { "name": "content_vector",
      "type": "Collection(Edm.Single)",
      "searchable": true,
      "retrievable": false,
      "stored": false,
      "dimensions": 1536,
      "vectorSearchProfile": "vector-profile-hnsw"
    },
    { "name": "source_url",     "type": "Edm.String",  "retrievable": true, "filterable": false },
    { "name": "last_modified",  "type": "Edm.DateTimeOffset", "filterable": true, "sortable": true },
    { "name": "file_type",      "type": "Edm.String",  "filterable": true, "facetable": true },
    { "name": "UserIds",
      "type": "Collection(Edm.String)",
      "permissionFilter": "userIds",
      "filterable": true,
      "retrievable": false
    },
    { "name": "GroupIds",
      "type": "Collection(Edm.String)",
      "permissionFilter": "groupIds",
      "filterable": true,
      "retrievable": false
    }
  ],
  "permissionFilterOption": "enabled",
  "vectorSearch": {
    "algorithms": [
      {
        "name": "hnsw-algorithm",
        "kind": "hnsw",
        "hnswParameters": {
          "m": 4,
          "efConstruction": 400,
          "efSearch": 100,
          "metric": "cosine"
        }
      }
    ],
    "profiles": [
      {
        "name": "vector-profile-hnsw",
        "algorithm": "hnsw-algorithm",
        "vectorizer": "openai-vectorizer"
      }
    ],
    "vectorizers": [
      {
        "name": "openai-vectorizer",
        "kind": "azureOpenAI",
        "azureOpenAIParameters": {
          "resourceUri": "{{aoaiEndpoint}}",
          "deploymentId": "{{aoaiDeploymentName}}",
          "modelName": "{{aoaiModelName}}"
        }
      }
    ]
  },
  "semantic": {
    "defaultConfiguration": "default",
    "configurations": [
      {
        "name": "default",
        "prioritizedFields": {
          "titleField": { "fieldName": "title" },
          "prioritizedContentFields": [
            { "fieldName": "content" }
          ]
        }
      }
    ]
  }
}

###

# Step 3: Create skillset (run AFTER index is created)

POST {{searchUrl}}/skillsets?api-version={{apiVersion}}
Content-Type: application/json
api-key: {{apiKey}}

{
  "name": "sharepoint-vectorization-skillset",
  "skills": [
    {
      "@odata.type": "#Microsoft.Skills.Text.SplitSkill",
      "name": "text-chunking",
      "description": "Split documents into chunks for embedding",
      "context": "/document",
      "textSplitMode": "pages",
      "maximumPageLength": 2000,
      "pageOverlapLength": 500,
      "unit": "characters",
      "defaultLanguageCode": "en",
      "inputs": [
        { "name": "text", "source": "/document/content" }
      ],
      "outputs": [
        { "name": "textItems", "targetName": "chunks" }
      ]
    },
    {
      "@odata.type": "#Microsoft.Skills.Text.AzureOpenAIEmbeddingSkill",
      "name": "embedding",
      "description": "Generate embeddings for each chunk",
      "context": "/document/chunks/*",
      "resourceUri": "{{aoaiEndpoint}}",
      "deploymentId": "{{aoaiDeploymentName}}",
      "modelName": "{{aoaiModelName}}",
      "dimensions": 1536,
      "inputs": [
        { "name": "text", "source": "/document/chunks/*" }
      ],
      "outputs": [
        { "name": "embedding", "targetName": "content_vector" }
      ]
    }
  ],
  "indexProjections": {
    "selectors": [
      {
        "targetIndexName": "sharepoint-docs-index",
        "parentKeyFieldName": "parent_id",
        "sourceContext": "/document/chunks/*",
        "mappings": [
          { "name": "content",        "source": "/document/chunks/*" },
          { "name": "content_vector",  "source": "/document/chunks/*/content_vector" },
          { "name": "title",           "source": "/document/metadata_spo_item_name" },
          { "name": "source_url",      "source": "/document/metadata_spo_item_weburi" },
          { "name": "last_modified",   "source": "/document/metadata_spo_item_last_modified" },
          { "name": "file_type",       "source": "/document/metadata_spo_item_extension" },
          { "name": "UserIds",         "source": "/document/metadata_user_ids" },
          { "name": "GroupIds",        "source": "/document/metadata_group_ids" }
        ]
      }
    ],
    "parameters": {
      "projectionMode": "skipIndexingParentDocuments"
    }
  }
}


###

# Step 4: Create indexer (run AFTER skillset is created)

POST {{searchUrl}}/indexers?api-version={{apiVersion}}
Content-Type: application/json
api-key: {{apiKey}}

{
  "name": "sharepoint-indexer",
  "dataSourceName": "sharepoint-datasource",
  "targetIndexName": "sharepoint-docs-index",
  "skillsetName": "sharepoint-vectorization-skillset",
  "schedule": {
    "interval": "PT2H"
  },
  "parameters": {
    "batchSize": 10,
    "maxFailedItems": -1,
    "maxFailedItemsPerBatch": -1,
    "configuration": {
      "indexedFileNameExtensions": ".pdf,.docx,.pptx,.xlsx,.txt",
      "excludedFileNameExtensions": ".png,.jpg,.jpeg,.gif",
      "dataToExtract": "contentAndMetadata"
    }
  },
  "fieldMappings": [
    {
      "sourceFieldName": "metadata_spo_site_library_item_id",
      "targetFieldName": "id",
      "mappingFunction": { "name": "base64Encode" }
    },
    {
      "sourceFieldName": "metadata_user_ids",
      "targetFieldName": "UserIds"
    },
    {
      "sourceFieldName": "metadata_group_ids",
      "targetFieldName": "GroupIds"
    }
  ]
}


###

#############################################
# TESTING â€“ Toggle ACL filter on/off
#############################################
# The production index has permissionFilterOption: "enabled", which blocks
# unauthenticated queries (e.g. Foundry playground, Search Explorer).
# Use the PUT below to temporarily DISABLE it for testing, then RE-ENABLE.
#
# NOTE: Creating a separate test index/indexer doesn't work because the
# SharePoint data source with ACL ingestion forces permissionFilter fields.
# A separate data source without ACLs would require a new OAuth device-code flow.

### Disable ACL filter (for testing)
# Fetches current index def, sets permissionFilterOption to "disabled", PUTs back.
# Run this BEFORE testing in playground / Search Explorer.

PUT {{searchUrl}}/indexes/sharepoint-docs-index?api-version={{apiVersion}}
Content-Type: application/json
api-key: {{apiKey}}

< ./scripts/index-acl-disabled.json

###

### Re-enable ACL filter (after testing)
# IMPORTANT: Always re-enable before going to production!

PUT {{searchUrl}}/indexes/sharepoint-docs-index?api-version={{apiVersion}}
Content-Type: application/json
api-key: {{apiKey}}

< ./scripts/index-acl-enabled.json

###

### Test search (hybrid: keyword + vector + semantic)
POST {{searchUrl}}/indexes/sharepoint-docs-index/docs/search?api-version={{apiVersion}}
Content-Type: application/json
api-key: {{apiKey}}

{
  "search": "how do companies make money",
  "queryType": "semantic",
  "semanticConfiguration": "default",
  "select": "title, content, source_url",
  "top": 5,
  "count": true,
  "vectorQueries": [
    {
      "kind": "text",
      "text": "how do companies make money",
      "fields": "content_vector",
      "k": 5
    }
  ]
}